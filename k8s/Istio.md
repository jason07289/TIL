# Istio
- Istio를 통해 쿠버네티스의 복잡성을 줄일 수 있다.
- k8s에서 각 app들의 네트워크 연결을 쉽게 설정할 수 있도록 지원해준다.
- Istio는 Envoy를 Data Plane으로 사용하고 이를 Control해준다.
- k8s 환경의 Service Mesh 관리에서 사장 많이 사용된다.

## 기능
1. 트래픽 통제
   - 트래픽 분할
     - 서로 다른 버전의 서비스를 배포한 후, 버전별로 트래픽의 양을 조절할 수 있는 기능.
     - ex) 새 버전의 서비스 배포 시 새로운 버전에는 5%의 트래픽을 보내고 기존 버전에는 95%를 보내는 등 카나리 형식의 배포가 가능
   - 컨텐츠 기반의 트래픽 분할
     - 단순한 커넥션 기반의 트래픽 분할이 아닌, 네트워크 패킷의 내용을 기반으로 라우팅이 가능하다.
     - ex) 클라이언트가 ios일 경우 podA로 보낼 수 있고 aos일 경우 podB로 보내는 등의 라우팅이 가능하다.
  
2. 서비스간 안정성 제공(Resilience)
   - pilot은 트래픽 통제를 통해 서비스 호출에 대한 안정성을 제공한다.
   - 헬스체크 및 서비스 디스커버리
     - Pilot은 대상 서비스가 여러개의 인스턴스로 구성이 되어 있으면 이를 로드밸런싱하고, 이 서비스들에 대해 주기적으로 상태체크를 한다.
     - 만약, 장애가 난 서비스가 있으면 자동으로 서비스에서 제거
   - Retry, Timeout, Circuit breaker
     - 서비스간의 호출 안정성을 위해서, 재시도 횟수를 통제할 수 있다.
     - 호출을 했을 때 일정 시간 응답이 오지 않으면(Time out) 에러 처리가 가능하고 MSA 패턴 중 하나인 Circuit Breaker 패턴을 지원한다.

3. 보안
   - 통신 보안
     - 기본적으로 envoy를 통해서 통신하는 모든 트래픽을 자동으로 TLS를 이용해서 암호화 한다.(서비스간의 통신이 디폴트로 암호화)
     - 암호화를 위해 인증서를 사용하는데, 이 인증서를 이용해 TLS 통신을 한다.
   - 서비스 인증과 인가
     - Istio는 서비스에 대한 인증을 제공하는데, 크게 서비스와 서비스간 호출에서, 서비스를 인증하는 기능과, 서비스를 호출하는 클라이언트를 직접 인증 할 수 있다.
   - 서비스간 인증
     - 서비스간 인증은 인증서를 이용하여 양방향 TLS 인증을 이용해 서비스가 서로를 식별하고 인증한다.
    - 서비스와 사용자간 인증
      - 엔드유저, 사용자와도 인증이 가능함. JWT 토큰을 사용한다.
    - 인가를 통한 권한 통제
      - 권한 통제도 가능
      - 기본적으로 역할 기반의 권한 인증(RBAC : Role based authorization control)을 지원한다.
      - 인증된 사용자나 서비스는 각각 사용자 계정이나 k8s의 서비스 어카운트로 계정이 정의된다. 이 계정에 Role을 부여하여 서비스 접근권한을 정의한다.

4. 모니터링
    ![image](https://user-images.githubusercontent.com/38865267/155079384-aa2dbf9a-cf1d-49ac-b08f-2b9efa79e900.png)

   - Istio는 네트워크 트래픽을 모니터링함으로써, 서비스간에 호출 관계가 어떻게 되고, 응답시간, 처리량 등의 다양한지표를 수집하여 모니터링이 가능하다.
   - 서비스 A가 B를 호출할 때 호출 트래픽은 각각의 envoy 프록시를 통하게 되고, 호출을 할 때, 응답시간과 서비스의 처리량이 Mixer로 전달 된다. 이 지표들은 Logging Backend에 저장된다.
   - 이 Mixer는 플러그인이 가능한 adaptor 구조로 이식성이 좋다.


## Mesh-Agnostic Code(istio/envoy) vs Mesh-Aware Code(Eureka) 아키텍처 비교
- Proxy를 사이드카 형식으로 이용하는 Mesh-Agnostic(istio/envoy)
    ![image](https://user-images.githubusercontent.com/38865267/155079753-34f7b6b8-9661-4143-a66b-af6088066031.png)
    - Agnostic? 신의 존재를 믿지 않는.. 즉 각 서비스들이 mesh의 존재를 알고있지 않다.
- 프로그램 코드로 Service Mesh를 구성하는 Mesh-Aware (Spring Cloud Eureka)
    ![image](https://user-images.githubusercontent.com/38865267/155080154-a06eb4b9-3b89-426f-8781-e5c5fad5f7fb.png)
    - Aware? 알고 있다... 각 서비스들이 mesh의 존재를 알고 있다. 그래서 hystrix 같은 것도 코드 내에서 구현했던거 같음

### 서비스 매쉬
